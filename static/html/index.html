<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serka</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://unpkg.com/alpinejs-component@latest/dist/component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @keyframes flyIn {
            from {
                transform: translateY(200px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-fly-in {
            animation: flyIn 0.8s ease-out;
        }

        .ellipsis {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .break-all {
            word-break: break-all;
        }

        .ellipsis-multiline {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 3;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        button {
            cursor: pointer;
        }

        a {
            color: #0000EE;
            text-decoration: underline;
        }

        a:visited {
            color: #551A8B;
        }

        a:hover {
            color: #0056b3;
        }

        .modal {
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
        }
    </style>
    <script>
        async function performSearch(state) {
            state.splash = false;
            state.thinking = true;
            state.answer = '';
            ragSearch(state);
            try {
                const response = await fetch(`/search?q=${state.query}&collection=${state.selected_collection}`);
                state.results = await response.json();
            } catch (e) {
                console.error(e);
            } finally {
                state.thinking = false;
            }
        }

        async function ragSearch(state) {
            try {
                const response = await fetch(`/rag?q=${state.query}&collection=${state.selected_collection}`);
                answer = await response.json();
                state.answer = marked.parse(answer.answer);
            } catch (e) {
                console.error(e);
            }
        }

        async function giveFeedback(event, state) {

            console.log('Giving feedback...');
            console.log(event.target);
        }

        async function get_collection_list(state) {
            try {
                const response = await fetch(`/list`);
                const result = await response.json();
                state.collections = result.collections;
                if (state.collections.length > 0)
                    state.selected_collection = state.collections[0];
                state.thinking = false;
            } catch (e) {
                console.error(e);
            }
        }
        window.onload = function () {
            document.getElementById('searchInput').focus();
        };
        document.addEventListener('keydown', function (event) {
            if (event.ctrlKey && event.shiftKey && event.key === 'F') {
                event.preventDefault();
                document.getElementById('searchInput').focus();
            }
        });
    </script>
</head>

<body class="flex flex-col items-center justify-center h-screen bg-gray-100" x-data="{
    query: '',
    selected_collection: '',
    collections: [],
    results: [],
    answer: '',
    thinking: true,
    splash: true,
    feedbackItem: '',
    feedbackText: '',
    showModal: false,
    async search() {
        performSearch(this);
    },
    async get_collections(){
        get_collection_list(this);
    },
    async feedback(event){
        giveFeedback(event, this);
    },
    openModal(feedbackItem) {
        this.feedbackItem = feedbackItem;
        this.showModal = true;
    },
    closeModal() {
        this.showModal = false;
    },
}" x-init="get_collections()">
    <div x-show="splash">
        <img src="/static/img/ukceh-logo.png" alt="UKCEH logo" />
        <h1 class="text-3xl font-bold mb-6 text-gray-800">Serka</h1>
    </div>
    <div :class="!splash ? 'fixed top-0 left-0 w-full justify-center' : 'animate-fly-in w-100'" class="p-6 z-10"
        x-show="collections.length">
        <div id="searchBox"
            class="bg-white shadow-md p-2 flex items-center z-10 rounded-lg w-full border border-gray-200">
            <input id="searchInput" :disabled="thinking" @keydown.enter="search" x-model="query" type="text"
                placeholder="Search..." class="w-full p-2 border-none focus:outline-none" />
            <select x-model="selected_collection" class="w-20 p-2 border-none focus:outline-none">
                <template x-for="collection in collections">
                    <option x-text="collection"></option>
                </template>
            </select>
            <button :disabled="thinking" @click="search" class="bg-blue-500 text-white px-4 py-2 rounded-lg">
                <i :class="thinking? 'fa-spinner fa-spin' : 'fa-search'" class="fas"></i>
            </button>
        </div>
    </div>
    <div x-show="!collections.length">No collections available</div>

    <div x-show="results.length" class="absolute top-0 left-0 mt-20 p-6 pr-3 w-2/3 z-0 text-gray-500">
        <div class="text-xs">Semantic Search Results:</div>
        <template x-for="item in results">
            <div class="bg-white p-5 rounded-lg shadow-md text-justify mb-6 border border-gray-200">
                <div class="h-6 ellipsis text-lg">
                    <a x-text="item.title" :title="item.title" :href="item.url" target="_blank"></a>
                </div>
                <div x-text="item.url" class="text-xs h-5 ellipses break-all"></div>
                <div class="max-h-18 ellipsis-multiline text-gray-900 mt-3" x-text="item.content" :title="item.content">
                </div>
                <div class="mt-3">
                    <span class="text-xs">
                        Feedback:
                    </span>
                    <span class="px-3">
                        <button title="Helpful" @click="feedback($event)">
                            <i class="fa-regular fa-thumbs-up"></i>
                        </button>
                        <button title="Unhelpful" @click="feedback($event)">
                            <i class="fa-regular fa-thumbs-down"></i>
                        </button>
                    </span>
                    <button title="Detailed Feedback" @click="openModal(item.title)">
                        <i class="fa-regular fa-pen-to-square"></i>
                    </button>
                </div>
            </div>
        </template>
    </div>
    <div x-show="answer" class="absolute top-0 right-0 mt-20 p-6 pl-3 w-1/3 z-0 text-gray-500">
        <div class="text-xs">Generative Answer:</div>
        <div class="bg-white p-6 rounded-lg shadow-md text-justify border border-gray-200">
            <div x-html="answer"></div>
            <div class="mt-3">
                <span class="text-xs">
                    Feedback:
                </span>
                <span class="px-3">
                    <button title="Helpful" @click="feedback($event)">
                        <i class="fa-regular fa-thumbs-up"></i>
                    </button>
                    <button title="Unhelpful" @click="feedback($event)">
                        <i class="fa-regular fa-thumbs-down"></i>
                    </button>
                </span>
                <button title="Detailed Feedback" @click="openModal(answer)">
                    <i class="fa-regular fa-pen-to-square"></i>
                </button>
            </div>
        </div>
    </div>

    <div x-show="showModal" class="modal">
        <div class="modal-content text-gray-500 rounded-lg border border-gray-200">
            <button title="Close" class="float-right" @click="closeModal">
                <i class="fa-regular fa-x"></i>
            </button>
            <h2 class="text-xl font-bold mb-6">Feedback</h2>
            <table class="w-full">
                <tr>
                    <td class="align-top">Query:</td>
                    <td>
                        "<span x-text="query"></span>"
                    </td>
                </tr>
                <tr>
                    <td class="align-top">Item:</td>
                    <td>
                        <div class="italic" x-text="feedbackItem"></div>
                    </td>
                </tr>
                <tr>
                    <td class="align-top">Feedback:</td>
                    <td><textarea x-model="feedbackText" placeholder="Please enter feedback about this item..."
                            class="w-full h-16 p-2 border border-gray-300 rounded mb-4"></textarea></td>
                </tr>
            </table>
            <button class="bg-blue-500 text-white px-4 py-2 rounded-lg" @click="closeModal">Submit</button>
        </div>
    </div>
</body>

</html>
